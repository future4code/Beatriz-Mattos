module.exports=function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseDataBase=void 0;const r=i(n(16));class s{getConnection(){return null===s.connection&&(s.connection=r.default({client:"mysql",connection:{host:process.env.DB_HOST,port:3306,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_DATABASE_NAME}})),s.connection}static destroyConnection(){return o(this,void 0,void 0,(function*(){s.connection&&(yield s.connection.destroy(),s.connection=null)}))}}t.BaseDataBase=s,s.connection=null},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.USER_ROLES=t.Authenticator=void 0;const i=o(n(17));class r{static getExpiresIn(){return Number(process.env.ACCESS_TOKEN_EXPIRES_IN)}generateToken(e){return i.default.sign({id:e.id},process.env.JWT_KEY,{expiresIn:r.getExpiresIn()})}getData(e){const t=i.default.verify(e,process.env.JWT_KEY);return{id:t.id,role:t.role}}}t.Authenticator=r,function(e){e.NORMAL="NORMAL",e.ADMIN="ADMIN"}(t.USER_ROLES||(t.USER_ROLES={}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserDatabase=void 0;const i=n(0);class r extends i.BaseDataBase{createUser(e,t,n,i,s){return o(this,void 0,void 0,(function*(){yield this.getConnection().insert({id:e,name:t,email:n,password:i,role:s}).into(r.TABLE_NAME)}))}getUserByEmail(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().select("*").from(r.TABLE_NAME).where({email:e}))[0]}))}getUserById(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().select("*").from(r.TABLE_NAME).where({id:e}))[0]}))}}t.UserDatabase=r,r.TABLE_NAME="User"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdGenerator=void 0;const o=n(14);t.IdGenerator=class{generate(){return o.v4()}}},function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=r(n(15));t.default=class{hash(e){return s(this,void 0,void 0,(function*(){const t=Number(process.env.BCRYPT_COST),n=yield a.genSalt(t);return yield a.hash(e,n)}))}compare(e,t){return s(this,void 0,void 0,(function*(){return yield a.compare(e,t)}))}}},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RecipeDatabase=void 0;const r=n(0),s=i(n(22));class a extends r.BaseDataBase{createRecipe(e,t,n,i,r=s.default().format("YYYY-MM-DD")){return o(this,void 0,void 0,(function*(){yield this.getConnection().insert({recipe_id:e,author_id:t,title:n,description:i,created_at:r}).into(a.TABLE_NAME)}))}getUserById(e){return o(this,void 0,void 0,(function*(){const t=yield this.getConnection().select("*").from(a.TABLE_NAME).where({id:e});return r.BaseDataBase.destroyConnection(),t[0]}))}getRecipeById(e){return o(this,void 0,void 0,(function*(){const t=yield this.getConnection().select("*").from(a.TABLE_NAME).where({recipe_id:e});return r.BaseDataBase.destroyConnection(),t[0]}))}}t.RecipeDatabase=a,a.TABLE_NAME="Recipe"},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UsersRelationDatabase=void 0;const i=n(0);class r extends i.BaseDataBase{followUser(e,t){return o(this,void 0,void 0,(function*(){yield this.getConnection().insert({user_id:e,user_to_follow:t}).into(r.TABLE_NAME)}))}unfollowUser(e,t){return o(this,void 0,void 0,(function*(){yield this.getConnection().delete().from(r.TABLE_NAME).where({user_id:e,user_to_follow:t})}))}}t.UsersRelationDatabase=r,r.TABLE_NAME="users_relation"},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.handler=void 0;const i=o(n(8)),r=n(9);n(28),t.handler=i.default(r.app)},function(e,t){e.exports=require("serverless-http")},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0;const i=o(n(10)),r=o(n(11)),s=o(n(12)),a=n(13),c=n(18),u=n(19),d=n(20),l=n(21),f=n(23),p=n(24),h=n(25),v=n(26);r.default.config(),t.app=i.default(),t.app.use(s.default({origin:!0})),t.app.use(i.default.json()),t.app.post("/signup",a.signUpEndpoint),t.app.post("/login",c.loginEndpoint),t.app.get("/user/profile",u.getUserProfileEndpoint),t.app.get("/user/:id",d.getUserEndpoint),t.app.post("/recipe",l.createRecipeEndpoint),t.app.get("/recipe/:id",f.getRecipeEndpoint),t.app.post("/user/follow",p.followUserEndpoint),t.app.post("/user/unfollow",h.unfollowUserEndpoint),t.app.get("/feed",v.getFeedEndpoint),t.default=t.app;{const e=t.app.listen(process.env.PORT||3003,()=>{if(e){const t=e.address();console.log("Server is running in http://localhost:"+t.port)}else console.error("Failure upon starting server.")})}},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("cors")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.signUpEndpoint=void 0;const r=n(3),s=i(n(4)),a=n(2),c=n(1),u=n(0);t.signUpEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=e.body.name,o=e.body.email,i=e.body.password,u=e.body.role;if(!n||!o||!i)throw new Error("Insira todas as informações necessárias para o cadastro.");if(!o||-1===o.indexOf("@"))throw new Error("E-mail inválido.");if(i.length<6)throw new Error("A senha deve conter no mínimo 6 caracteres.");const d=(new r.IdGenerator).generate(),l=new s.default,f=yield l.hash(i),p=new a.UserDatabase;yield p.createUser(d,n,o,f,u);const h=(new c.Authenticator).generateToken({id:d,role:u});t.status(200).send({access_token:h})}catch(e){t.status(400).send({message:e.message})}yield u.BaseDataBase.destroyConnection()}))},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("knex")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.loginEndpoint=void 0;const r=n(0),s=n(2),a=i(n(4)),c=n(1);t.loginEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=e.body.email,o=e.body.password,i=e.body.role,r=new s.UserDatabase,u=yield r.getUserByEmail(n),d=new a.default;if(!(yield d.compare(o,u.password)))throw new Error("Usuário ou senha inválidos");if(!n||-1===n.indexOf("@"))throw new Error("Invalid email");if(!n||!o)throw new Error("Parâmetros inválidos.");const l=(new c.Authenticator).generateToken({id:u.id,role:i});t.status(200).send({access_token:l})}catch(e){t.status(400).send({message:e.message})}yield r.BaseDataBase.destroyConnection()}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getUserProfileEndpoint=void 0;const i=n(2),r=n(1),s=n(0);t.getUserProfileEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{e.headers.authorization;const n=(new r.Authenticator).getData(e.headers.authorization),o=new i.UserDatabase,s=yield o.getUserById(n.id);if("NORMAL"!==s.role)throw t.status(401).send({message:"Acesso negado."}),new Error("Apenas um usuário normal pode acessar essa funcionalidade.");t.status(200).send({userName:s.name,userEmail:s.email,userId:s.id,role:s.role})}catch(e){t.status(400).send({message:e.message})}s.BaseDataBase.destroyConnection()}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getUserEndpoint=void 0;const i=n(2),r=n(1),s=n(0);t.getUserEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=new r.Authenticator,o=(yield n.getData(e.headers.authorization),new i.UserDatabase),s=yield o.getUserById(e.params.id);t.status(200).send({userId:s.id,userName:s.name,userEmail:s.email,role:s.role})}catch(e){t.status(400).send({message:e.message})}s.BaseDataBase.destroyConnection()}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createRecipeEndpoint=void 0;const i=n(1),r=n(5),s=n(3);t.createRecipeEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=(new i.Authenticator).getData(e.headers.authorization),o=(new s.IdGenerator).generate(),a=new r.RecipeDatabase,c={recipe_id:e.body.recipe_id,author_id:n.id,title:e.body.title,description:e.body.description,created_at:e.body.created_at};yield a.createRecipe(o,c.author_id,c.title,c.description,c.created_at),t.status(200).send({message:"Receita criada com sucesso!"})}catch(e){t.status(400).send({message:e.message})}}))},function(e,t){e.exports=require("moment")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getRecipeEndpoint=void 0;const i=n(1),r=n(5);t.getRecipeEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{(new i.Authenticator).getData(e.headers.authorization);const n=new r.RecipeDatabase,o=yield n.getRecipeById(e.params.id);t.status(200).send({id:o.id,title:o.title,description:o.description,createdAt:o.created_at})}catch(e){t.status(400).send({message:e.message})}}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.followUserEndpoint=void 0;const i=n(1),r=n(2),s=n(6);t.followUserEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=e.headers.authorization,o=e.body.userToFollowId,a=new i.Authenticator,c=a.getData(n).id;if(!o)throw new Error("Insira um id válido");const u=new r.UserDatabase;if(!(yield u.getUserById(o)))throw new Error("Usuário não existe");const d=new s.UsersRelationDatabase;yield d.followUser(c,o),t.status(200).send({message:"Usuário seguido com sucesso!"})}catch(e){t.status(400).send({message:e.message})}}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.unfollowUserEndpoint=void 0;const i=n(1),r=n(2),s=n(6);t.unfollowUserEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=e.headers.authorization,o=e.body.userToUnfollowId,a=new i.Authenticator,c=a.getData(n).id;if(!o)throw new Error("Insira um id válido");const u=new r.UserDatabase;if(!(yield u.getUserById(o)))throw new Error("Usuário não existe");const d=new s.UsersRelationDatabase;yield d.unfollowUser(c,o),t.status(200).send({message:"Você deixou de seguir o usuário com sucesso!"})}catch(e){t.status(400).send({message:e.message})}}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getFeedEndpoint=void 0;const i=n(1),r=n(0),s=n(27);t.getFeedEndpoint=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=e.headers.authorization,o=new i.Authenticator,r=o.getData(n).id,a=new s.FeedDatabase,c=yield a.getFeed(r);t.status(200).send(c)}catch(e){t.status(400).send({message:e.message})}yield r.BaseDataBase.destroyConnection()}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FeedDatabase=void 0;const i=n(0);class r extends i.BaseDataBase{getFeed(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().raw(`\n        SELECT Recipe.recipe_id, title, description, created_at, User.id, User.name\n        FROM Recipe\n        JOIN users_relation\n        ON users_relation.user_to_follow = Recipe.author_id\n        AND users_relation.user_id = '${e}'\n        JOIN User\n        ON Recipe.author_id = User.id\n        `))[0]}))}}t.FeedDatabase=r},function(e,t){e.exports=require("mysql")}]);